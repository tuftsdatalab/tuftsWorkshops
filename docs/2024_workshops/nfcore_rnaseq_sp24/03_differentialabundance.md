# nf-core/differentialabundance

nf-core/differentialabundance is a bioinformatics pipeline that can be used to analyse data represented as matrices, comparing groups of observations to generate differential statistics and downstream analyses. The pipeline supports RNA-seq data such as that generated by the nf-core rnaseq workflow, and Affymetrix arrays via .CEL files.

<img src="https://raw.githubusercontent.com/nf-core/differentialabundance/1.4.0//docs/images/workflow.png" alt="nf-core/differentialabundance" width="80%">

## Create the working directory

```
mkdir -p /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance
```

## reference genome gtf

In the last RNAseq workshop, we selected `save_reference`. So that all refereneced data will be saved for our future use. Today we can reuse the gtf file for human genome.

```
ls -1 /cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/genome/
```

You can see the GRCh38 reference genome's gtf and fasta files. In addition, you can see the newly created STAR `index` and `rsem` folders that can be used for your future RNA-Seq analysis.

```
Homo_sapiens.GRCh38.111.gtf
Homo_sapiens.GRCh38.dna.primary_assembly.fa
Homo_sapiens.GRCh38.dna.primary_assembly.fa.fai
Homo_sapiens.GRCh38.dna.primary_assembly.fa.sizes
Homo_sapiens.GRCh38.dna.primary_assembly.filtered.bed
Homo_sapiens.GRCh38.dna.primary_assembly.filtered.gtf
genome.transcripts.fa
index/
rsem/
```

Let's create a softlink of the gtf to our `differentialabundance` folder

```
cd /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance
ln -s /cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/genome/Homo_sapiens.GRCh38.111.gtf .
```

## matrix

In the output folder of RNAseq workshop, you can find the count file we need `salmon.merged.gene_counts.tsv` via `ls`.

```
$ ls -1 /cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/*.tsv
```

```
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.gene_counts.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.gene_counts_length_scaled.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.gene_counts_scaled.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.gene_lengths.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.gene_tpm.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.transcript_counts.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.transcript_lengths.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.transcript_tpm.tsv
/cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/tx2gene.tsv
```

We can create a soft link of `salmon.merged.gene_counts.tsv` into our differentialabundance folder

```
cd /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance
ln -s /cluster/tufts/biocontainers/workshop/Spring2024/rnaseq/rnaseqOut/star_salmon/salmon.merged.gene_counts.tsv .
```

## samplesheet.csv

| sample    | treatment | replicate | batch |
| --------- | --------- | --------- | ----- |
| GFPkd_1   | GFPkd     | 1         | A     |
| GFPkd_2   | GFPkd     | 2         | A     |
| GFPkd_3   | GFPkd     | 3         | A     |
| PRMT5kd_1 | PRMT5kd   | 1         | A     |
| PRMT5kd_2 | PRMT5kd   | 2         | A     |
| PRMT5kd_3 | PRMT5kd   | 3         | A     |

You can copy my samplesheet.csv to your workding directory.
```
cd /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance
cp /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance/samplesheet.csv .
```
## contrast.csv

| id               | variable  | reference | target  | blocking |
| ---------------- | --------- | --------- | ------- | -------- |
| PRMT5kd_vs_GFPkd | treatment | GFPkd     | PRMT5kd |          |

You can copy my contrast.csv to your workding directory.
```
cd /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance
cp /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance/contrast.csv .
```
## Open OnDemand

Click `differentialabundance` in `Bioinformatics Apps`.

### Arguments

- Number of hours: 2
- Select cpu parition: batch
- Reservation for class, training, workshop: Default
- Version: 1.4.0
- Working Directory: `/cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance` ## Change this to your own directory
- outdir: DEGout
- study_type: rnaseq
- input: samplesheet.csv
- contrasts: contrast.csv
- matrix: salmon.merged.gene_counts.tsv
- differential_min_fold_change: 1.5
- observations_id_col: sample
- observations_name_col: sample
- gsea_run: true
- gsea_gene_sets: /cluster/tufts/biocontainers/workshop/Spring2024/gsea/h.all.v2023.2.Hs.symbols.gmt.txt
- shinyngs_build_app: true
- report_title: PRMT5kd vs. GFPkd
- report_author: Yucheng Zhang ## You can put your name as the author

```
------------------------------------------------------
                                        ,--./,-.
        ___     __   __   __   ___     /,-._.--~'
  |\ | |__  __ /  ` /  \ |__) |__         }  {
  | \| |       \__, \__/ |  \ |___     \`-._,-`-,
                                        `._,._,'
  nf-core/differentialabundance v1.4.0
------------------------------------------------------
Core Nextflow options
  runName                      : cheesy_almeida
  containerEngine              : singularity
  container                    : [RMARKDOWNNOTEBOOK:biocontainers/r-shinyngs:1.8.4--r43hdfd78af_0]
  launchDir                    : /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance
  workDir                      : /cluster/tufts/biocontainers/workshop/Spring2024/differentialabundance/work
  projectDir                   : /cluster/tufts/biocontainers/nf-core/pipelines/nf-core-differentialabundance/1.4.0/1_4_0
  userName                     : yzhang85
  profile                      : tufts
  configFiles                  :

Input/output options
  input                        : samplesheet.csv
  contrasts                    : contrast.csv
  outdir                       : DEGout

Abundance values
  matrix                       : salmon.merged.gene_counts.tsv
  affy_cel_files_archive       : null
  querygse                     : null

Affy input options
  affy_background              : false
  affy_cdfname                 : null
  affy_build_annotation        : false

Proteus input options
  proteus_plotmv_loess         : false

Filtering
  filtering_min_abundance      : 1
  filtering_min_samples        : 1

Differential analysis
  differential_min_fold_change : 1.5

DESeq2 specific options (RNA-seq only)
  deseq2_independent_filtering : false
  deseq2_shrink_lfc            : false
  deseq2_vs_blind              : false

Limma specific options (microarray only)
  limma_spacing                : null
  limma_block                  : null
  limma_correlation            : null

GSEA
  gsea_run                     : true
  gsea_gene_sets               : /cluster/tufts/biocontainers/workshop/Spring2024/gsea/h.all.v2023.2.Hs.symbols.gmt.txt

Shiny app settings
  shinyngs_shinyapps_account   : null
  shinyngs_shinyapps_app_name  : null
  shinyngs_guess_unlog_matrices: false

Reporting options
  report_file                  : /cluster/tufts/biocontainers/nf-core/pipelines/nf-core-differentialabundance/1.4.0/1_4_0/assets/differentialabundance_report.Rmd
  logo_file                    : /cluster/tufts/biocontainers/nf-core/pipelines/nf-core-differentialabundance/1.4.0/1_4_0/docs/images/nf-core-differentialabundance_logo_light.png
  css_file                     : /cluster/tufts/biocontainers/nf-core/pipelines/nf-core-differentialabundance/1.4.0/1_4_0/assets/nf-core_style.css
  citations_file               : /cluster/tufts/biocontainers/nf-core/pipelines/nf-core-differentialabundance/1.4.0/1_4_0/CITATIONS.md
  report_title                 : PRMT5kd vs. GFPkd
  report_author                : Yuhceng Zhang
  report_description           : null
  report_scree                 : false

Reference genome options
  gtf                          : Homo_sapiens.GRCh38.111.gtf

Institutional config options
  config_profile_description   : The Tufts University HPC cluster profile provided by nf-core/configs.
  config_profile_contact       : Yucheng Zhang
  config_profile_url           : https://it.tufts.edu/high-performance-computing

Max job request options
  max_cpus                     : 72
  max_memory                   : 120 GB
  max_time                     : 7d

!! Only displaying parameters that differ from the pipeline defaults !!
------------------------------------------------------
If you use nf-core/differentialabundance for your analysis please cite:

* The pipeline
  https://doi.org/10.5281/zenodo.7568000

* The nf-core framework
  https://doi.org/10.1038/s41587-020-0439-x

* Software dependencies
  https://github.com/nf-core/differentialabundance/blob/master/CITATIONS.md

[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -

[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -
[-        ] process > NFCORE_DIFFERENTIALABUNDANC... -

.
.
.

executor >  slurm (15)
[af/6ca92c] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[08/da4d86] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[9e/ed2886] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[5e/f9baa7] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[93/b8a70c] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[82/d70bae] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[29/056e2d] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[70/cf23b6] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[dd/999607] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[24/38a2b9] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[06/a30630] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[5f/c153b2] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[0a/a0e8a9] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[b5/3b4b1d] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
[04/12d84a] process > NFCORE_DIFFERENTIALABUNDANC... [100%] 1 of 1 ✔
-[nf-core/differentialabundance] Pipeline completed successfully-
Completed at: 15-Mar-2024 14:56:20
Duration    : 17m 11s
CPU hours   : 0.3
Succeeded   : 15
```
